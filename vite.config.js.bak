import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import { VitePWA } from "vite-plugin-pwa"; // ğŸ†• å¼•å…¥ PWA å¥—ä»¶

// https://vitejs.dev/config/
export default defineConfig(({ mode }) => ({
  // ğŸ†• åœ¨ plugins é™£åˆ—ä¸­åŠ å…¥ VitePWA
  plugins: [
    react(),
    mode !== "test" && VitePWA({
      registerType: "autoUpdate", // è‡ªå‹•æ›´æ–°æ¨¡å¼ï¼šéƒ¨ç½²æ–°ç‰ˆå¾Œï¼Œä½¿ç”¨è€…é‡æ•´å³æ›´æ–°
      includeAssets: ["favicon.ico", "apple-touch-icon.png", "masked-icon.svg"],

      // Manifest è¨­å®šï¼šé€™æ±ºå®šäº†å®‰è£åˆ°æ‰‹æ©Ÿæ¡Œé¢æ™‚çš„æ¨£å­
      manifest: {
        name: "2026 æ±äº¬è¼•äº•æ¾¤å…­æ—¥éŠ",
        short_name: "æ—¥æœ¬æ—…éŠ",
        description: "æ±äº¬è¼•äº•æ¾¤å®¶åº­æ—…éŠè¡Œç¨‹åŠ©æ‰‹",
        theme_color: "#ffffff",
        display: "standalone", // è®“å®ƒçœ‹èµ·ä¾†åƒåŸç”Ÿ App (æ²’æœ‰ç€è¦½å™¨ç¶²å€åˆ—)
        icons: [
          {
            src: "pwa-192x192.png", // æ³¨æ„ï¼šéœ€è¦åœ¨ public è³‡æ–™å¤¾æ”¾å…¥é€™äº›åœ–ç‰‡ï¼Œå¦å‰‡ Console æœƒå ±éŒ¯ï¼Œä½†ä¸å½±éŸ¿é‹ä½œ
            sizes: "192x192",
            type: "image/png",
          },
          {
            src: "pwa-512x512.png",
            sizes: "512x512",
            type: "image/png",
          },
        ],
      },

      // ğŸ› ï¸ Workbox å¿«å–ç­–ç•¥ï¼šé€™æ˜¯ã€Œè¤‡é›œå¿«å–ã€çš„æ ¸å¿ƒ
      workbox: {
        // 1. éœæ…‹è³‡æºé å…ˆå¿«å–ï¼šè®“ HTML, JS, CSS, åœ–ç‰‡åœ¨é›¢ç·šæ™‚ä¹Ÿèƒ½è¼‰å…¥
        globPatterns: ["**/*.{js,css,html,ico,png,svg,jpg,jpeg}"],

        // 2. åŸ·è¡Œæ™‚å¿«å– (Runtime Caching)
        runtimeCaching: [
          // (A) Google Fonts å­—å‹ï¼šå¾ˆå°‘è®Šå‹•ï¼Œå„ªå…ˆç”¨å¿«å–ï¼ŒéæœŸæ™‚é–“è¨­å¾ˆé•· (1å¹´)
          {
            urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
            handler: "CacheFirst",
            options: {
              cacheName: "google-fonts-cache",
              expiration: {
                maxEntries: 10,
                maxAgeSeconds: 60 * 60 * 24 * 365,
              },
              cacheableResponse: {
                statuses: [0, 200],
              },
            },
          },
          // (B) å¤©æ°£ API (Open-Meteo)ï¼šè³‡æ–™éœ€è¦æ–°é®®
          // ä½¿ç”¨ NetworkFirst (ç¶²è·¯å„ªå…ˆ)ï¼šæœ‰ç¶²è·¯æŠ“æœ€æ–°çš„ï¼Œæ²’ç¶²è·¯æ‰ç”¨èˆŠè³‡æ–™
          {
            urlPattern: /^https:\/\/api\.open-meteo\.com\/.*/i,
            handler: "StaleWhileRevalidate", // ğŸ‘ˆ æ”¹æˆé€™æ‹›ï¼šæœ‰èˆŠçš„å…ˆçµ¦èˆŠçš„ï¼ŒèƒŒæ™¯å†æ›´æ–°
            options: {
              cacheName: "weather-api-cache",
              expiration: {
                maxEntries: 10,
                maxAgeSeconds: 60 * 60 * 24, // å»¶é•·åˆ° 24 å°æ™‚ï¼Œç¢ºä¿éš”å¤©æ²’ç¶²è·¯ä¹Ÿèƒ½çœ‹æ˜¨å¤©çš„é å ±
              },
              cacheableResponse: {
                statuses: [0, 200], // ğŸ‘ˆ é—œéµï¼šå¼·åˆ¶å¿«å–ï¼Œé¿å…å› ç‚º CORS å•é¡Œä¸å­˜
              },
            },
          },
          // (C) å¤–éƒ¨åœ–ç‰‡æˆ–åœ°åœ–åœ–ç£š (å¦‚æœæœ‰ç”¨åˆ°)
          {
            urlPattern: ({ request }) => request.destination === "image",
            handler: "CacheFirst",
            options: {
              cacheName: "images-cache",
              expiration: {
                maxEntries: 60,
                maxAgeSeconds: 60 * 60 * 24 * 30, // 30 å¤©
              },
            },
          },
        ],
      },
    }),
  ].filter(Boolean),

  base: "/2026_tokyo/", // âœ… ä¿ç•™æ‚¨çš„è¨­å®š

  build: {
    // âœ… ä¿ç•™æ‚¨çš„å„ªåŒ–è¨­å®š
    chunkSizeWarningLimit: 1000,
    rollupOptions: {
      output: {
        manualChunks: {
          "react-vendor": ["react", "react-dom"],
          "motion-vendor": ["framer-motion"],
          "icons-vendor": ["lucide-react"],
        },
      },
    },
  },
  test: {
    environment: "jsdom",
    globals: true,
    setupFiles: ["./src/test/setup.js"],
  },
}));
